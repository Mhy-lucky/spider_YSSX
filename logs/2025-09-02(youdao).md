# 工作日志(2025-09-02)

**项目**：网页翻译、爬虫、Selenium自动化翻译、断点续爬

---

## 一、Youdao 自动翻译脚本开发

### 1. 初始目标

* 使用 Selenium 自动化翻译网页内容（Youdao）。
* 实现按行翻译、支持大段文本分批翻译。
* 实现断点续爬（记录已翻译内容，避免重复翻译）。
* 支持服务器无头模式运行。

---

### 2. 关键问题与解决方案

#### a. ChromeDriver 与 Chrome 版本不匹配!!!!!!!

* 报错：

  ```
  selenium.common.exceptions.TimeoutException: Message: timeout: Timed out receiving message from renderer
  ```
* 原因：服务器 Chrome 版本为 139，Chromedriver 版本不匹配。
* 解决方案：

  * 使用 `chromedriver_autoinstaller` 自动匹配当前 Chrome 版本，无需手动配置。
  * 或者在本地调试时指定固定版本的 Chromedriver。

---

#### b. Selenium 无法在服务器上正常启动 / 页面加载超时

* 报错：

  ```
  HTTPConnectionPool(host='localhost', port=50674): Read timed out. (read timeout=120)
  ```
* 原因：

  1. 无头模式下服务器内存/CPU不足，页面渲染慢。
  2. 网络访问Youdao页面慢或被阻断。
  3. ChromeDriver 与 Chrome 版本问题。
  4. 本地有浏览器环境（Chrome/Chromium + 图形界面），能正常启动。服务器上大概率是 没有图形环境 或 没有安装 Chrome/Chromium，导致 chromedriver 启动失败，Selenium 一直连不上端口，120 秒后超时。

* 解决方案：

  * 加入无头模式参数：

    ```python
    chrome_options.add_argument("--headless=new")
    chrome_options.add_argument("--no-sandbox")
    chrome_options.add_argument("--disable-gpu")
    chrome_options.add_argument("--disable-dev-shm-usage")
    chrome_options.add_argument("--remote-debugging-port=9222")
    ```
  * 增加 `WebDriverWait` 或 `time.sleep` 等待页面渲染。
  * 确认服务器可访问翻译页面。
  * 后两条代码最关键，其他的也必不可少。
  *解释：
  *--disable-dev-shm-usage
  → 默认 Chrome 会用 /dev/shm 做共享内存，但服务器上这个目录一般很小，会导致 Chrome crash。
  *--remote-debugging-port=9222
  → 在无头环境下，有时 Chrome 和 Selenium 通信会卡死，开一个调试端口能避免。

---

#### c. 翻译断点续爬功能

* 原始问题：程序中断后重新启动，会从头开始翻译。
* 改进：

  1. 增加 `processed_lines.txt` 文件记录已翻译的行。
  2. 启动时读取文件，跳过已翻译内容。
  3. 翻译完成后及时更新文件。
  4. 对每批次文本进行字符拆分，防止单次发送过多字符导致失败。

---

#### d. 翻译文本对应

* 需求：每一行输入必须和对应翻译结果一一对应。
* 实现：

  * 使用 `zip` 绑定原文和翻译结果。
  * 输出文件格式：`原文\t翻译结果`。
  * 支持大段文本分批发送，每批翻译后依次写入文件。

---

#### e. 文件监控与提示优化

* 优化点：

  1. 当输入文件无新内容时，只输出一次提示：

     ```
     无新内容，等待中...
     ```
  2. 支持每隔一定时间（`CHECK_INTERVAL`）检查文件是否有新增内容。

---


### 3. 自动化脚本实现要点

#### a. Youdao翻译

* 使用 `chromedriver_autoinstaller` 自动安装匹配版本。
* 无头模式运行：

  ```python
  chrome_options.add_argument("--headless=new")
  chrome_options.add_argument("--disable-gpu")
  chrome_options.add_argument("--no-sandbox")
  chrome_options.add_argument("--disable-dev-shm-usage")
  ```
* 输入与输出绑定：

  * 输入框 ID: `js_fanyi_input`
  * 输出框 ID: `js_fanyi_output_resultOutput`
* 支持断点续爬，已翻译内容记录在 `processed_lines.txt`。
* 每批次最大字符数限制，防止页面超时。

#### b. Google翻译

* 通过 URL 直接访问翻译页面，避免手动输入：

  ```python
  url = f"https://translate.google.com/?sl=auto&tl={TARGET_LANG}&text={encoded_text}&op=translate"
  ```
* 提取翻译结果 CSS: `span[jsname='W297wb']`
* 对长文本拆分，分批翻译。

---

### 4. 服务器文件操作

* 需求：复制文件而非移动。
* Linux/Mac 操作：

  ```bash
  cp source.txt /path/to/destination/
  ```
* Python 方式：

  ```python
  import shutil
  shutil.copy("source.txt", "/path/to/destination/")
  ```

---

### 5. 总结

1. Selenium自动翻译开发完成，支持：

   * 无头模式服务器运行
   * 大段文本分批翻译
   * 每行输入对应翻译
   * 断点续爬，避免重复翻译
2. 遇到的主要问题：

   * ChromeDriver/Chrome版本不匹配
   * 页面加载超时 / 服务器性能限制
   * 输入输出绑定
3. 改进措施：

   * 使用 `chromedriver_autoinstaller`
   * 增加等待时间、重试机制
   * 断点续爬功能
   * 输出文件绑定原文与翻译
   * 监控无新内容时只输出一次提示
4. 下一步建议：

   * 可在服务器上增加日志，记录每批翻译状态
   * 对翻译失败行增加重试机制
   * 对大型文件可增加分块处理和异步翻译，提高稳定性

---

