
# 📝 工作日志（2025-08-22）
** 不要尽信GPT说的洗完数据要几天几个小时，盲目地进行分块。。。。自己运行试试不就知道了！ **
** 需要check检查清晰的数据是否有问题，可以再开一个终端进入服务器，边清洗边检查，不用特地把文件下载一小部分再去巴拉巴拉检查！ **

## 1️⃣ 清洗小说大文件 `chinese_web_novel.zh`

**任务描述**：

* 清洗超大中文小说语料（约 370G），保留正文，去除广告、章节标题、重复行、特殊符号等噪声内容。
* 原始文件路径：`/data1/to_hongyao/chinese_web_novel.zh`
* 清洗输出：`data_clean.zh`
* 删除行日志：`deleted_lines.log`

**遇到的问题及分析**：

1. **输出文件行数异常**

   * 初始版本 `clean_novel.py` 清洗后输出文件行数约翻倍。
   * 原因：写入文件时使用 `line + "\n"`，而 `line` 本身已包含换行符 `\n`，导致每行被拆成两行写入。
   * 解决方案：直接写入 `line`，避免重复换行。

2. **去重方式打乱顺序**

   * 原去重使用 `sort -u`，虽然可以去重，但文件原始顺序被打乱。
   * 解决方案：采用轻量 **保序去重**，通过 `seen_hashes` 集合记录文本哈希，只写未出现过的行。

3. **广告残留**

   * 清洗后仍发现残留广告，如“百度搜索…”，“白金小说网…”，“随梦小说网…”，“新世纪小说网…”，“无错小说网…”。
   * 原因：广告/来源过滤规则未覆盖所有中文网站和广告句型。
   * 解决方案：扩展 `SITE_BRANDS` 列表，增加中文广告网站及广告句型，增强 `is_valid` 过滤规则。

4. **日志文件占用空间过大**

   * 并行清洗脚本为每块生成 `.log` 文件，在 370G 文件情况下占用大量磁盘空间。
   * 解决方案：移除 `.log` 文件输出，仅在控制台打印 `[progress] kept=xxx / seen=xxx`。

5. **大文件内存压力**

   * 文件过大，无法一次性读入内存。
   * 解决方案：

     * 逐行处理，避免一次性加载。
     * 使用轻量去重，仅保存每行文本的哈希。
     * 不生成日志文件，减少磁盘占用。

---

## 2️⃣ 并行处理尝试

**目标**：分块处理大文件，提高清洗速度。

**问题及分析**：

1. `split` 分块失败

   * 原计划将大文件拆分为每块 50,000,000 行，写入 `/data2/tmp_clean_parts`。
   * 遇到权限限制，用户无写入权限，导致 `split` 失败。

2. 进度监控 `.log` 文件过多

   * 并行每块生成 `.log` 文件，占用大量空间，管理困难。

**解决方案**：

* 放弃拆分，顺序逐行处理大文件。
* 或在用户有写权限的目录拆分。
* 输出进度通过终端打印，不生成 `.log` 文件。

---

## 3️⃣ 清洗进度与输出

* 原 `clean_novel.py` 打印 `[progress] kept=xxx / seen=xxx`，无需额外日志文件即可查看进度。
* 保序去重和逐行处理方式可在保证内存安全的情况下，清洗大文件。

---

## 4️⃣ 当前优化版本特点

* **轻量保序去重**：只记录文本哈希，避免内存占用。
* **无日志文件输出**：减少磁盘占用。
* **保留原文件顺序**。
* **逐行打印进度**。
* **修正重复行写入问题**。
* **广告/来源过滤规则增强**，覆盖更多中文广告网站。

---

## 5️⃣ 数据统计示例

* 原始行数：约 370G，对应约 1.3B 行。

* 清洗后部分统计：

  ```
  完成 ✅ 总行数: 143,731, 保留: 122,618, 删除: 21,113
  Drop reasons 统计：
    - duplicate: 9,110
    - repeat_char: 8,958
    - url_email_phone: 2,030
    ...
  ```

* 多次清洗前的重复问题已修正。

---

## 6️⃣ 后续优化建议

1. **大文件清洗策略**

   * 保持顺序逐行处理，轻量去重。
   * 避免拆分成过多块文件，降低磁盘空间压力。
   * 并行处理仅在可用磁盘空间充足且权限允许时使用。

2. **去重优化**

   * 对超大文件，可考虑 **hash 分桶** 或 **外部排序** 方法。

3. **日志管理**

   * 不必为每块生成 `.log` 文件，进度信息可终端打印。
   * 删除旧拆分文件和日志，释放磁盘空间。

4. **清洗规则优化**

   * 广告、章节标题、网址、重复字符、特殊符号、非正文关键词规则已完善。
   * 可根据实际情况动态调整 `DEFAULT_MAX_LEN` 或广告关键词列表。

---

